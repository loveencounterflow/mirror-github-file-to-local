#!/usr/bin/env bash
set -euo pipefail

# shellcheck disable=SC2034
function set_colors() {
  rainbow=🌈🌈🌈
  blink='\x1b[5m'
  bold='\x1b[1m'
  reverse='\x1b[7m'
  underline='\x1b[4m'
  reset='\x1b[0m'
  black='\x1b[38;05;16m'
  blue='\x1b[38;05;27m'
  green='\x1b[38;05;34m'
  cyan='\x1b[38;05;51m'
  sepia='\x1b[38;05;52m'
  indigo='\x1b[38;05;54m'
  steel='\x1b[38;05;67m'
  brown='\x1b[38;05;94m'
  olive='\x1b[38;05;100m'
  lime='\x1b[38;05;118m'
  red='\x1b[38;05;124m'
  crimson='\x1b[38;05;161m'
  plum='\x1b[38;05;176m'
  pink='\x1b[38;05;199m'
  orange='\x1b[38;05;208m'
  gold='\x1b[38;05;214m'
  tan='\x1b[38;05;215m'
  yellow='\x1b[38;05;226m'
  grey='\x1b[38;05;240m'
  darkgrey='\x1b[38;05;234m'
  white='\x1b[38;05;255m'
  warn="$red$reverse$bold"
  }
set_colors

#-----------------------------------------------------------------------------------------------------------
function check_is_repo() {
  git status > /dev/null ; if [[ $? -eq 129 ]]; then
    echo
    echo -e "❌$warn Not a git repo. $reset"
    echo
    exit 111
    fi
  }

#-----------------------------------------------------------------------------------------------------------
function check_no_changes() {
  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo
    git status -sb
    echo
    echo -e "❌$warn Uncommitted changes detected. Please commit or stash them first. $reset"
    echo
    exit 111
    fi
  }

# #-----------------------------------------------------------------------------------------------------------
# function join_paths() {
#   local left="${1%/}"   # remove trailing slash from first
#   local right="${2#/}"  # remove leading slash from second
#   echo "$left/$right"
#   }

#-----------------------------------------------------------------------------------------------------------
function prepend_message() {
  local url="$1"
  local local_file_path="$2"
  local comment_marker="$3"
  #.........................................................................................................
  { echo
    echo "$comment_marker==========================================================================================================="
    echo "$comment_marker updated on $(date '+%Y-%m-%d %H:%M:%S %Z')"
    echo "$comment_marker from $url"
    echo "$comment_marker==========================================================================================================="
    echo
    cat "$local_file_path"
    } > temp && mv temp "$local_file_path"
  }

#-----------------------------------------------------------------------------------------------------------
# shellcheck disable=SC2155
function mirror_url() {
  local url_plus="$1"
  local local_prefix="$2"
  local comment_marker="$3"
  #.........................................................................................................
  local clean_url=$(echo "$url_plus" | sed -E 's|###/||g')
  local local_file_suffix=$(echo "$url_plus" | sed -E 's|^.+###/(.+)|\1|g')
  local local_dir_suffix=$(dirname "$local_file_suffix")
  #.........................................................................................................
  local local_file_path="$local_prefix/$local_file_suffix"
  local local_dir_path="$local_prefix/$local_dir_suffix"
  local exit_code=0
  #.........................................................................................................
  echo
  echo -e "$gold$clean_url$reset" "$blue"'->'"$reset" "$lime$local_file_path$reset"
  mkdir -p "$local_dir_path"
  set +e ; wget --no-verbose --server-response --output-document="$local_file_path" "$clean_url" ; exit_code="$?" ; set -e
  # set +e ; wget --no-verbose --output-document="$local_file_path" "$clean_url" ; exit_code="$?" ; set -e
  #.........................................................................................................
  if [[ $exit_code -ne 0 ]]; then
    echo
    echo -e "❌$warn wget encountered an error; see above $reset"
    echo
    exit 111
    fi
  #.........................................................................................................
  prepend_message "$clean_url" "$local_file_path" "$comment_marker"
  #.........................................................................................................
  }

check_is_repo
check_no_changes
mirror_url 'https://raw.githubusercontent.com/loveencounterflow/metteur/refs/heads/main/###/src/cli.coffee'   './mirror'  '#'
mirror_url 'https://raw.githubusercontent.com/loveencounterflow/metteur/refs/heads/main/###/lib/cli.js'       './mirror'  '//'
# mirror_url 'https://raw.githubusercontent.com/loveencounterflow/metteur/refs/heads/main/src/foo.coffee' './mirror'
# mirror_url 'https://gist.github.com/luciomartinez/c322327605d40f86ee0c/raw/43ac25a9384fa1c8da89135a6e517afab49792e1/slash.sh' './mirror'

  # 10302 10302  mkcd git-mirrors/metteur
  # 10303 10303  git init
  # 10304 10304  git remote add origin https://github.com/loveencounterflow/metteur
  # 10305 10305  git fetch --depth=1 origin
  # 10306 10306  l
  # 10307 10307  git config --list --show-origin
  # 10308 10308  git config core.sparseCheckout true
  # 10309 10309  git config --list --show-origin
  # 10310 10310  echo "src/cli.coffee" >> .git/info/sparse-checkout
  # 10311 10311  git checkout origin/main
  # 10312 10312  l
  # 10313 10313  l src
  # 10314 10314  git checkout origin/main

